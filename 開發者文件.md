# 🛠️ AI 教材轉換系統 - 開發者文件 (Developer Guide)

> **文件版本**: 1.1
> **更新日期**: 2026-01-18
> **適用對象**: 系統維護人員、後端工程師

---

## 1. 專案架構與技術堆疊

本專案是一個基於 Node.js 的 Web 應用程式，旨在將 Markdown 或純文字教材轉換為格式精美的 PDF 與 Word 文件。

### 核心技術
*   **Runtime**: Node.js
*   **Web Framework**: Express.js
*   **PDF Engine**: Puppeteer (Headless Chrome) - 負責將 HTML 精準渲染為 PDF。
*   **Word Engine**: Pandoc - 負責將 Markdown 轉換為 DOCX (含目錄功能)。
*   **Frontend**: Vanilla HTML/CSS/JS (不依賴大型框架，保持輕量)。

### 系統流程
1.  **使用者上傳**: 前端 `index.html` 上傳 `.md` 檔案。
2.  **伺服器接收**: `server.js` 透過 `multer` 接收檔案。
3.  **預處理**:
    *   檢查是否為純文字檔。
    *   若是純文字，呼叫 `textToMarkdown.js` 進行「智能結構識別」。
4.  **轉換**:
    *   **HTML**: `converter.js` 將 Markdown 轉為 HTML 並注入 CSS 樣式。
    *   **PDF**: Puppeteer 讀取 HTML -> 列印為 PDF。
    *   **Word**: 呼叫系統 Pandoc 指令 -> 轉為 Docx。
### v1.3 更新 (2026/01/19) - AI 配額深度優化
*   **關鍵變更**：關閉啟發式自動偵測，改為**「標記觸發」**。
*   **技術說明**：移除 `src/textToMarkdown.js` 中對連續短行、Tab 鍵的自動 AI 判斷，顯著降低 429 錯誤發生率。

### v1.2 更新 (2026/01/19) - 格式優化
*   **Word 分頁**：改用 OpenXML `<w:br w:type="page"/>` 解決 Pandoc 忽略 `\newpage` 的問題。
*   **強制標標記**：導入 `【表格開始】` 語法。

5.  **回應**: 回傳 JSON (含預覽 HTML 與下載連結)。

---

## 2. 專案結構說明

```
AI教材轉換專案115/
├── .env                  # 環境變數 (API Key, Port)
├── package.json          # 專案依賴定義
├── 啟動程式.bat           # Windows 快速啟動腳本
├── src/
│   ├── server.js         # 主程式入口，API 路由定義
│   ├── converter.js      # 核心轉換邏輯 (Markdown -> HTML/PDF/Word)
│   └── textToMarkdown.js # 智能純文字轉 Markdown 引擎
├── public/
│   └── index.html        # 前端介面 (含 CSS 與 JS 邏輯)
├── output/               # 輸出檔案存放區 (PDF/DOCX)
└── uploads/              # 上傳檔案暫存區
```

---

## 3. 核心模組詳解

### 3.1 智能轉換引擎 (`src/textToMarkdown.js`)

這是本專案的關鍵功能，解決「純文字貼上沒有標題格式」的問題。

*   **自動標題識別邏輯**:
    *   **H1**: 識別「導論」、「第X章」、「附錄」等關鍵字。
    *   **H2**: 識別 `1. xxx` 格式。
    *   **H3**: 識別 `1.1 xxx` 格式。
    *   **H4**: 識別 `1.1.1 xxx` 格式。
    *   **上下文判斷**: 若某行短於 30 字且下一行很長，判定為小標題 (H3)。
*   **目錄保護**: 透過 `inTOC` 標記，避免將「目錄」區塊內的文字誤轉為標題。

### 3.2 轉換與排版 (`src/converter.js`)

*   **CSS 樣式系統**:
    *   定義於 `markdownToHTML` 函式中的 `<style>` 區塊。
    *   **強制換頁**: `h1 { page-break-before: always; }` (首頁除外)。
    *   **排版優化**: 設定了行高、字體 (微軟正黑體)、表格樣式。
*   **PDF 生成**:
    *   使用 Puppeteer 的 `page.pdf()`。
    *   設定頁眉/頁腳 (`displayHeaderFooter: true`)。
*   **Word 生成**:
    *   呼叫外部指令: `pandoc input.md -o output.docx --toc`。
    *   **注意**: 必須安裝 Pandoc 才能運作。

### 3.3 伺服器邏輯 (`src/server.js`)

*   **API `/api/convert`**:
    *   接收檔案 -> 判斷類型 -> 轉換 -> 回傳結果。
    *   回傳格式: `{ htmlPreview: "...", files: { pdf: "...", docx: "..." } }`。
    *   **預覽機制**: 直接回傳生成的 HTML 字串給前端顯示，不需額外儲存預覽檔。

---

## 4. 開發環境建置

若您需要修改程式碼，請依以下步驟設定開發環境：

1.  **Clone / 下載專案**:
    ```bash
    git clone [Repo URL]
    cd AI教材轉換專案115
    ```

2.  **安裝依賴**:
    ```bash
    npm install
    ```

3.  **環境變數**:
    *   確認 `.env` 檔案存在。
    *   主要變數: `PORT=3000`。

4.  **啟動開發伺服器**:
    ```bash
    # 使用 node 直接啟動
    node src/server.js
    
    # 或使用 npm script (若有設定)
    npm start
    ```

5.  **測試**:
    *   打開瀏覽器訪問 `http://localhost:3000`。

---

## 5. 常見維護與擴充指南

*   **Q: 如何修改 PDF 的頁邊距？**
    *   A: 修改 `src/converter.js` 中 `page.pdf()` 的 `margin` 設定。

*   **Q: 如何更改字體？**
    *   A: 修改 `src/converter.js` 中 CSS 的 `body { font-family: ... }`。

*   **Q: Word 轉換失敗？**
    *   A: 90% 是因為伺服器/電腦未安裝 Pandoc。請在終端機輸入 `pandoc -v` 檢查。

*   **Q: 如何增加新的標題識別規則？**
    *   A: 編輯 `src/textToMarkdown.js` 中的 `detectHeadingLevel` 函式。
