# 📝 專案開發紀錄與交接事項 (Handover Log)

> **紀錄人**: Antigravity (AI Assistant)
> **交接日期**: 2026-01-18
> **專案狀態**: 穩定版 (v1.1)

---

## 1. 專案演進簡述

本專案經歷了幾個主要階段：
1.  **POC 階段**: 驗證使用 Gemini API 進行內容生成的可能性 (早期嘗試)。
2.  **核心轉換實作**: 決定使用 Puppeteer (HTML -> PDF) 與 Pandoc (Markdown -> Word) 雙引擎架構。
3.  **問題解決**:
    *   遇到「純文字貼上無格式」痛點 -> 開發 `textToMarkdown.js` 正則引擎。
    *   遇到「使用者無法確認結果」 -> 開發 Web 預覽介面。
4.  **穩定化**: 優化 CSS 排版 (強制換頁、字體調整)。

---

## 2. 關鍵技術決策 (Why we did this)

### 為什麼不全程用 AI 轉換？
*   **成本與速度**: 呼叫 LLM (如 Gemini) 處理長文檔非常消耗 Token 且速度慢。
*   **穩定性**: LLM 輸出的格式 (JSON/Markdown) 有時不穩定。
*   **決策**: 採用 **"混合模式"**。
    *   **規則引擎 (Regex)**: 處理 90% 的結構化任務 (標題識別、列表)，速度快且免費。
    *   **AI**: (目前保留介面) 未來可用於「摘要生成」或是「題目設計」，但不負責基礎排版。

### 為什麼 PDF 用 Puppeteer？
*   相較於 `jspdf` 或其他前端 library，Puppeteer 是真正的 Chrome 渲染引擎。
*   **優點**: **CSS 支援度 100% (包含 Flexbox, Grid, Google Fonts)**，排版結果與網頁預覽完全一致。

### 為什麼 Word 用 Pandoc？
*   Pandoc 是文件轉換的工業標準。
*   它能生成真正的 Word「目錄功能 (TOC)」，這是 JS library 很難做到的。

---

### 2026/01/19 - 格式優化與穩定性修正
*   **問題**: 使用者回報 Word 檔未正確分頁，且部分垂直條列式資料未被識別為表格。
*   **除錯**:
    1.  發現 Pandoc 忽略 Markdown 的 `\newpage` 指令。
    2.  AI 模型因 Rate Limit (429) 導致偶發性轉換失敗，回退為純文字。
*   **解決方案**:
    1.  **Word 分頁**: 改用 OpenXML `<w:br w:type="page"/>` 直接注入，強制 Word 分頁。
    2.  **表格識別**: 實作「強制表格標記」(`【表格開始】`/`【表格結束】`)，提供使用者 100% 可控的轉換手段。
    3.  **API 穩定性**: 在 `callGeminiToConvertTable` 增加指數退避重試機制 (10s/20s/30s)，解決 429 錯誤。
*   **狀態**: 測試通過，已更新至 v1.2。

## 3. 待辦事項 (Todo)已知限制與未來優化方向

### 目前限制
1.  **圖片處理**: 目前僅支援 Markdown 語法引用網路圖片 (`![alt](http://...)`)，不支援直接上傳圖片檔插入文章。
2.  **Word 樣式客製化**: Word 的輸出樣式是 Pandoc 預設值，若要客製化 (例如公司 Logo、特定字型)，需要製作 Pandoc Reference Doc (`custom-reference.docx`)。
3.  **純文字識別極限**: 雖然 `detectHeadingLevel` 已經很聰明，但對於完全沒有編號且長度不一的標題，識別率仍有限。

### 建議後續開發項目
1.  **圖片上傳功能**: 修改 `multer` 設定，允許上傳圖片，並將其路徑取代到 Markdown 中。
2.  **AI 增強**: 恢復 Gemini API 串接，在此轉換流程中加入「AI 導讀生成」或「AI 關鍵字標註」。
3.  **多佈景主題**: 在前端增加 CSS 切換按鈕，讓使用者選擇「學術風」、「活潑風」、「暗黑模式」等 PDF 樣式。

---

## 4. 交接檢查清單 (Checklist)

接手同仁請確認以下事項：
- [ ] 能夠成功執行 `npm install` 並無錯誤。
- [ ] 確認本機已安裝 Pandoc 並加入環境變數 (`path`)。
- [ ] 能夠理解 `src/textToMarkdown.js` 中的正則表達式邏輯。
- [ ] 知道 PDF 輸出的檔案會用 `Date.now()` 命名，不會覆蓋舊檔，但需定期清理 `output/` 資料夾。

---

**備註**: 所有的程式碼註解都已經中文化，請善用 VS Code 的搜尋功能。
